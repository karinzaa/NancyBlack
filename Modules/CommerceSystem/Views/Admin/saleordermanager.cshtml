@inherits NantCom.NancyBlack.NancyBlackRazorViewBase
@{
    Layout = "_admin.cshtml";
}

@section Head
{
    <style>
        body, html {
            height: 100%;
        }

        body {
            overflow-x: scroll;
        }
    </style>
    <link href="~/Modules/CommerceSystem/Views/Admin/saleordermanager.min.css" rel="stylesheet" />
    <link href="/Content/Scripts/angular-chart.js-master/dist/angular-chart.css" rel="stylesheet" />
}

@section Scripts
{
    <script src="/Content/Scripts/Chart.js-master/Chart.min.js"></script>
    <script src="/Content/Scripts/angular-chart.js-master/dist/angular-chart.js"></script>
    <script src="/Modules/CommerceSystem/Views/Admin/js/saleorder.js"></script>

}

<div ng-module="saleorder"
     ng-controller="saleorder_list as ctrl"
     ncb-datacontext table="SaleOrder"
     id="ManageSaleorder">

    <div class="page-header">
        <h1>Selling Center</h1>
    </div>

    <tabset>
        <tab heading="General Summary">

            <div class="row">

                <div class="col-md-6"
                     ncg-chart
                     title="'Revenue'"
                     table="'SaleOrder'"
                     fn="'sum'"
                     select="'TotalAmount'">
                </div>

                <div class="col-md-6"
                     ncg-chart
                     title="'Sale Volume'"
                     table="'SaleOrder'"
                     fn="'count'"
                     select="'TotalAmount'">
                </div>
            </div>

        </tab>
        <tab heading="Product Summary">

        </tab>
    </tabset>


    <div class="page-header">
        <h3>Sale Orders</h3>
    </div>
    <div class="pull-right">
        <button class="btn btn-success"
                data-toggle="modal" data-target="#NewSaleOrderModal">
            <i class="fa fa-plus"></i>
            New SO            
        </button>
    </div>
    <ncb-ngtable tabletemplate="'tablecustomtemplate.html'" modalid="SaleOrderModal"
                 edit-fn="ctrl.viewOrderDetail(id)">
    </ncb-ngtable>

    <script type="text/ng-template" id="tablecustomtemplate.html">

        <table id="sotable"
               ncb-datatable
               class="table table-striped table-hover"
               style="width: 100%"
               ng-table="tableParams"
               show-filter="true">

            <tr ng-repeat="item in tableParams.data">
                <td data-title="'Order#'"
                    sortable="'SaleOrderIdentifier'"
                    filter="{ 'SaleOrderIdentifier': 'text' }">
                    <a href="/Admin/saleorder/{{item.id}}" ng-click="editFn({id: item.id})">
                        {{item.SaleOrderIdentifier }}
                    </a>
                    <p class="text-muted">
                        <i class="fa fa-clock-o"></i>
                        {{item.__updatedAt | date:'dd MMMM yyyy, HH:mm' }}
                    </p>
                </td>
                <td data-title="'Status'"
                    sortable="'Status'"
                    filter="{ 'Status': 'text' }">
                    {{item.Status }}
                </td>
                <td data-title="'Customer, S&H'"
                    sortable="'Customer'"
                    filter="{ 'Customer': 'text' }">

                    {{item.Customer.FirstName}}
                    {{item.Customer.LastName}}

                    <p class="text-muted">
                        <i class="fa fa-envelope"></i> : {{item.Customer.Email}}<br />
                        <i class="fa fa-mobile-phone"></i> : {{item.Customer.PhoneNumber}}
                    </p>

                    <div ng-repeat="(k,v) in item.ShippingDetails">
                        <b>{{k}}</b>: {{v}}
                    </div>

                </td>
                <td data-title="'S&H'"
                    sortable="'ShippingDetails'">
                    {{item.ShippingDetails.method}}
                </td>

                <td data-title="'Products'">
                    <div ng-repeat="id in item.Items">

                        <div ncb-vlookup="Product" key="{{id}}" scope>
                            <a href="{{data.Url}}" target="_blank">
                                {{data.Title}}
                            </a>
                            <ul>
                                <li ng-repeat="(k,v) in data.Attributes">
                                    <b>{{k}}</b> : {{v}}
                                </li>
                            </ul>
                        </div>
                    </div>
                </td>

                <td data-title="'Amount'"
                    sortable="'TotalAmount'"
                    filter="{ 'TotalAmount': 'text' }">
                    {{item.TotalAmount | number:2 }}
                </td>
                <td style="white-space: nowrap">

                    <a href="/Admin/saleorder/{{item.id}}" class="btn btn-info">
                        <i class="fa fa-edit"></i>
                    </a>

                    <a ng-href="/__commerce/saleorder/{{item.SaleOrderIdentifier}}/receipt"
                       class="btn btn-primary"
                       ng-disabled="object.Status == 'PaymentReceived'">
                        <span class="icon ion-printer"></span> IV
                    </a>
                    <a ng-href="/__commerce/saleorder/{{item.SaleOrderIdentifier}}/receipt"
                       class="btn btn-success"
                       ng-disabled="object.Status != 'PaymentReceived'">
                        <span class="icon ion-printer"></span> R
                    </a>
                </td>
            </tr>
        </table>

    </script>

    <ncb-modal id="NewSaleOrderModal"
               title="{{object.id == null ? 'Create SaleOrder' : 'Edit SaleOrder'}}"
               closebutton deletebutton>
        <form role="form" name="SaleOrderForm">

            <tabset>
                @*<tab heading="General">
                    
                    <input type="text" name="SaleOrderIdentifier" title="SaleOrderIdentifier"
                           ncb-textbox
                           ng-model="object.SaleOrderIdentifier" />                                        
                </tab>*@
                <tab heading="Items">
                    <table class="table table-hover"
                           ncb-listeditor
                           target="object.Items">
                        <thead>
                            <tr>
                                <th>Items</th>
                                <th width="16px"></th>
                            </tr>
                        </thead>
                        <tr ng-repeat="element in target">
                            <td>
                                <input class="form-control"
                                       placeholder="Items" disabled
                                       ng-model="element" />
                            </td>
                            <td>
                                <button class="btn btn-danger"
                                        ng-click="remove(element)">
                                    <i class="glyphicon glyphicon-remove"></i>
                                </button>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <input class="form-control"
                                       placeholder="Items"
                                       ng-model="newItem" />
                            </td>
                            <td>
                                <button class="btn btn-success"
                                        ng-click="add()">
                                    <i class="glyphicon glyphicon-plus"></i>
                                </button>
                            </td>
                        </tr>
                    </table>

                </tab>

            </tabset>

        </form>

        <ncb-footer>
            <button class="btn btn-primary btn-lg"
                    ng-click="ctrl.createSaleOrder(object)">
                <span ng-show="object.id == null">Create</span>
                <span ng-show="object.id != null">Save</span>
            </button>
        </ncb-footer>
    </ncb-modal>

</div>
